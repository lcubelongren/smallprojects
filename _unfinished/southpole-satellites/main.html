<!DOCTYPE html>
<body>
<div id="loadingText">Loading...</div>
<div id="titleText">South Pole Station Satellites</div>
<div id="infoContainer">
<div id="infoIcon">&#x2139;</div>
<div id="infoText">
<br>
A map of satellite coverage for the Amundsen-Scott South Pole Station,
where the U.S. Antarctic Program (USAP) currently uses three satellites for communication.<br>
<br>
The station is considered within coverage when a satellite is at least 10&deg; above the horizon.<br>
<br>
For the definitive source of satellite service, see the 
<a href="https://www.usap.gov/technology/1935/" target="_blank">official schedule</a>.<br>
<br>
Created by L.L. Longren<br>
<br>
rev. 09/2025
</div>
</div>
<table id="satelliteLegend"></table>
<canvas id="canvasMap"></canvas>
<canvas id="canvasCoverage"></canvas>
<div id="panelMapContainer"></div>
<div id="panelCoverageContainer"></div>
<div id="timeText"></div>
<datalist id="timeTicks">
<option value="0" label="+00 hrs"></option>
<option value="6" label="+06 hrs"></option>
<option value="12" label="+12 hrs"></option>
<option value="18" label="+18 hrs"></option>
<option value="24" label="+24 hrs"></option>
</datalist>
<table id="timeSchedule"></table>
</body>
<script type="module">

let dataLoaded = false;

let current_time = new Date();
current_time.setMinutes(0);
current_time.setSeconds(0);
current_time.setMilliseconds(0);
document.getElementById('timeText').innerText = current_time;

// TLEs obtained from: https://isstracker.pl/en/satellites
let satellite_info = {
	'TDRS-6': {  // https://isstracker.pl/en/satellites/22314
		'NORAD_num': '22314',
		'color': 'rgb(255 0 0 / 50%)',
		'location_history': [],
	},
	'DSCS-11': {  // https://isstracker.pl/en/satellites/26575
		'NORAD_num': '26575',
		'color': 'rgb(0 255 0 / 50%)',
		'location_history': [],
	},
	'DSCS-13': {  // https://isstracker.pl/en/satellites/25019
		'NORAD_num': '25019',
		'color': 'rgb(0 0 255 / 50%)',
		'location_history': [],
	},
}
async function loadTLE(sat) {
	let NORAD_num = satellite_info[sat]['NORAD_num'];
	let url = 'https://celestrak.org/NORAD/elements/gp.php?CATNR=' + NORAD_num + '&FORMAT=tle';
	let request = await fetch(url);
	let text = await request.text();
	return text;
}
async function preparePage() {
	for (let sat of Object.keys(satellite_info)) {
		let TLE = await loadTLE(sat);
		if (TLE.split('\n').length == 4) {
			dataLoaded = true;
		}
		satellite_info[sat]['tleLine1'] = TLE.split('\n')[1];
		satellite_info[sat]['tleLine2'] = TLE.split('\n')[2];
		document.getElementById('panelMapContainer').innerHTML += '<canvas id="canvasMap_' + sat + '"></canvas>';
		document.getElementById('panelCoverageContainer').innerHTML += '<canvas id="canvasCoverage_' + sat + '"></canvas>';
	}
	return satellite_info;
}
await preparePage();

function satelliteCalculation(sat, time) {

	let tleLine1 = satellite_info[sat]['tleLine1'];
	let tleLine2 = satellite_info[sat]['tleLine2'];
	  
	const satrec = satellite.twoline2satrec(tleLine1, tleLine2);
	const positionAndVelocity = satellite.propagate(satrec, time);
	const positionEci	= positionAndVelocity.position;
	const gmst = satellite.gstime(time);
	const positionGd = satellite.eciToGeodetic(positionEci, gmst);
	const longitude = positionGd.longitude,
		  latitude  = positionGd.latitude,
		  height    = positionGd.height;
	const longitudeDeg = satellite.degreesLong(longitude),
		  latitudeDeg  = satellite.degreesLat(latitude);
	
	let radius_earth = 6357;  // [kilometer]
	let circumference_earth = 40075;  // [kilometer]
	let elevation_angle = 10;  // [degrees] above horizon

	let satellite_lonlat = [longitudeDeg, latitudeDeg];
	let satellite_coverage_radius = coverageRadius(circumference_earth, radius_earth, elevation_angle, height);			
	function coverageRadius(c, r, e, h) {  // https://continuouswave.com/forum/viewtopic.php?t=2957
		return [c * (180 - Math.asin(r * Math.sin(90 + e) / (r + h)) - (90 + e)) / 360];
	}
	
	let satellite_geojson = {
		'coordinates': [[0, -90], satellite_lonlat],
		'type': 'LineString',
	};
	let satellite_distance = d3.geoLength(satellite_geojson) * radius_earth;
	
	return [satellite_lonlat, satellite_coverage_radius, satellite_distance];

}

async function loadData() {

	let land_path = './maps/land-50m.json';  // topojson
	let land_data;
	await d3.json(land_path)
	.then(function(data) {
		land_data = topojson.feature(data, data.objects.land);
	})
	
	let ocean_path = './maps/ne_110m_ocean.json';  // geojson
	let ocean_data;
	await d3.json(ocean_path)
	.then(function(data) {
		ocean_data = data;
	})
	
	let iceshelf_path = './maps/ne_50m_antarctic_ice_shelves_polys.json';  // geojson
	let iceshelf_data;
	await d3.json(iceshelf_path)
	.then(function(data) {
		iceshelf_data = data;
	})
	
	return [land_data, ocean_data, iceshelf_data];
}
let [land_data, ocean_data, iceshelf_data] = await loadData();

function getScale() { return Math.min(window.innerWidth, window.innerHeight) / 2.75; }
var scale = getScale();
function getPanelScale() { return Math.min(document.getElementById('panelMapContainer').offsetWidth, document.getElementById('panelMapContainer').offsetHeight) / 1.5; }
var panel_scale = getPanelScale();

function drawMap() {

	scale = getScale();
	panel_scale = getPanelScale();

	let canvas = document.getElementById('canvasMap');
	let context = canvas.getContext('2d');
	let canvas_size = Math.min(window.innerWidth, window.innerHeight);
	canvas.width = canvas_size;
	canvas.height = canvas_size;

	let projection = d3.geoOrthographic()
	.rotate([0, 90])
	.scale(scale)
	.translate([canvas.width / 2, canvas.height / 2]);
	
	let outline = { type: 'Sphere' };

	let path = d3.geoPath(projection, context);

	context.beginPath(), path(ocean_data), context.fillStyle='#adcfe6', context.fill();
	context.beginPath(), path(iceshelf_data), context.fillStyle='#e8f4f8', context.fill();
	context.beginPath(), path(land_data), context.fillStyle='#ffffff', context.fill();
	context.beginPath(), path(land_data), context.strokeStyle='#000000', context.lineWidth=0.5, context.stroke();
	context.beginPath(), path(outline), context.strokeStyle='#000000', context.lineWidth=1.0, context.stroke();
	
	for (let panel_canvas of document.getElementById('panelMapContainer').children) {

		let panel_context = panel_canvas.getContext('2d');
		let panel_canvas_size = document.getElementById('panelMapContainer').offsetWidth;
		panel_canvas.width = panel_canvas_size;
		panel_canvas.height = panel_canvas_size;

		let panel_sat = panel_canvas.id.split('_')[1];
		let [satellite_lonlat, satellite_coverage_radius, satellite_distance] = satelliteCalculation(panel_sat, current_time);

		let panel_projection = d3.geoEquirectangular()
		.center(satellite_lonlat)
		.scale(panel_scale)
		.translate([panel_canvas.width / 2, panel_canvas.height / 2]);
		
		let panel_path = d3.geoPath(panel_projection, panel_context);

		panel_context.beginPath(), panel_path(ocean_data), panel_context.fillStyle='#adcfe6', panel_context.fill();
		panel_context.beginPath(), panel_path(iceshelf_data), panel_context.fillStyle='#e8f4f8', panel_context.fill();
		panel_context.beginPath(), panel_path(land_data), panel_context.fillStyle='#ffffff', panel_context.fill();
		panel_context.beginPath(), panel_path(land_data), panel_context.strokeStyle='#000000', panel_context.lineWidth=0.8, panel_context.stroke();
		
	}
	
}

function drawCoverage() {

	let canvas = document.getElementById('canvasCoverage');
	let context = canvas.getContext('2d');
	let canvas_size = Math.min(window.innerWidth, window.innerHeight);
	canvas.width = canvas_size;
	canvas.height = canvas_size;

	let projection = d3.geoOrthographic()
	.rotate([0, 90])
	.scale(scale)
	.translate([canvas.width / 2, canvas.height / 2]);
	
	let path = d3.geoPath(projection, context);
	
	let southpole_fillColor;
	for (let sat of Object.keys(satellite_info)) {

		let [satellite_lonlat, satellite_coverage_radius, satellite_distance] = satelliteCalculation(sat, current_time);

		if (satellite_coverage_radius > satellite_distance) {
			southpole_fillColor = 'black';
			let connection_line = { type: 'LineString', coordinates: [[0, -90], satellite_lonlat] };
			context.beginPath(), path(connection_line), context.strokeStyle='#000000', context.lineWidth=2.5, context.stroke();
		}
		else {
			if (southpole_fillColor == undefined) {
				southpole_fillColor = 'white';
			}
		}
		
		let satellite_coverage = d3.geoCircle()
		.center(satellite_lonlat)
		.radius(satellite_coverage_radius * 360 / 40008);  // / circumference of Earth at poles [kilometers]
		context.beginPath(), path(satellite_coverage()), context.fillStyle=satellite_info[sat]['color'], context.fill();

		let satellite_center = d3.geoCircle()
		.center(satellite_lonlat)
		.radius(3000 / (scale * (Math.PI * 2)));
		context.beginPath(), path(satellite_center()), context.fillStyle=satellite_info[sat]['color'], context.fill();
		
	}

	let southpole = d3.geoCircle()
	.center([0, -90])
	.radius(1500 / (scale * (Math.PI * 2)));
	context.beginPath(), path(southpole()), context.fillStyle=southpole_fillColor, context.fill();
	context.beginPath(), path(southpole()), context.strokeStyle='black', context.lineWidth=1.5, context.stroke();
	
	for (let panel_canvas of document.getElementById('panelCoverageContainer').children) {
	
		let panel_context = panel_canvas.getContext('2d');
		let panel_canvas_size = document.getElementById('panelCoverageContainer').offsetWidth;
		panel_canvas.width = panel_canvas_size;
		panel_canvas.height = panel_canvas_size;	

		let panel_sat = panel_canvas.id.split('_')[1];
		let [satellite_lonlat, satellite_coverage_radius, satellite_distance] = satelliteCalculation(panel_sat, current_time);

		let fixed_current_time = new Date();
		fixed_current_time.setMinutes(0);
		fixed_current_time.setSeconds(0);
		let fixed_satellite_lonlat = satelliteCalculation(panel_sat, fixed_current_time)[0];
		
		let panel_projection = d3.geoEquirectangular()
		.center(fixed_satellite_lonlat)
		.scale(panel_scale)
		.translate([panel_canvas.width / 2, panel_canvas.height / 2]);
		
		let panel_path = d3.geoPath(panel_projection, panel_context);
		
		let panel_satellite_color = satellite_info[panel_sat]['color'].split('/')[0] + ')';

		let panel_satellite_fillColor;
		if (satellite_coverage_radius > satellite_distance) {
			panel_satellite_fillColor = panel_satellite_color;
			let connection_line = { type: 'LineString', coordinates: [[0, -90], satellite_lonlat] };
			panel_context.beginPath(), panel_path(connection_line), panel_context.strokeStyle=panel_satellite_color, panel_context.lineWidth=2.5, panel_context.stroke();
		}
		else {
			if (panel_satellite_fillColor == undefined) {
				panel_satellite_fillColor = 'white';
			}
		}
		
		let history_coordinates = satellite_info[panel_sat]['location_history'].slice(0, Number.parseInt(hr) + 1);
		let history_line = { type: 'LineString', coordinates: history_coordinates };
		panel_context.beginPath(), panel_path(history_line), panel_context.strokeStyle='#000000', panel_context.lineWidth=1.0, panel_context.stroke();

		let panel_satellite_center = d3.geoCircle()
		.center(satellite_lonlat)
		.radius(1500 / (panel_scale * (Math.PI * 2)));
		panel_context.beginPath(), panel_path(panel_satellite_center()), panel_context.fillStyle=panel_satellite_fillColor, panel_context.fill();
		panel_context.beginPath(), panel_path(panel_satellite_center()), panel_context.strokeStyle=panel_satellite_color, panel_context.lineWidth=1.5, panel_context.stroke();
		
	}
	
}

if (dataLoaded) {
	drawMap();
	drawCoverage();
}

window.addEventListener('resize', function (event) {
	if (dataLoaded) {
		drawMap();
		drawCoverage();
	}
});

let infoContainer = document.getElementById('infoContainer');
infoContainer.addEventListener('click', function (event) {
	infoContainer.style.transition = 'all 0.3s ease-out';
	if (infoContainer.className == '') {
		infoContainer.className = 'active';
	}
	else {
		infoContainer.className = '';
	}
});

let satelliteLegend = document.getElementById('satelliteLegend');
let legend_html = '';
legend_html += '<tr>';
for (let sat of Object.keys(satellite_info)) {
	legend_html += '<td><div style="background-color:' + satellite_info[sat]['color'] + '"></div><a>&nbsp;&nbsp;' + sat + '</a></td>';
}
legend_html += '</tr>';
satelliteLegend.innerHTML += legend_html;

let timeSchedule = document.getElementById('timeSchedule');
for (let sat of Object.keys(satellite_info)) {
	let row = '';
	row += '<tr>';
	for (let hr=0; hr <= 24; hr++) {
		let target_time = new Date();
		target_time.setTime(current_time.getTime() + ((60*60*1000) * hr));
		target_time.setMinutes(0);
		target_time.setSeconds(0);
		let [satellite_lonlat, satellite_coverage_radius, satellite_distance] = satelliteCalculation(sat, target_time);
		satellite_info[sat]['location_history'].push(satellite_lonlat)
		if (satellite_coverage_radius > satellite_distance) {
			row += '<td class="' + hr + '" style="background-color:' + satellite_info[sat]['color'] + '"></td>';
		}
		else {
			row += '<td class="' + hr + '" style="background-color:' + 'black' + '"></td>';
		}
	}
	row += '</tr>';
	timeSchedule.innerHTML += row;
}

var hr = '0';
let all_bins = document.getElementsByTagName('td');
for (let bin of all_bins) {
	if (bin.offsetParent.id == 'timeSchedule') {
		if (bin.className == hr) {
			bin.style.opacity = '1.00';
		}
		else {
			bin.style.opacity = '0.33';
		}
		bin.addEventListener('mouseenter', function (event) {
			if (bin.className != hr) {
				hr = bin.className;
				for (let bin of all_bins) {
					if (bin.offsetParent.id == 'timeSchedule') {
						if (bin.className == hr) {
							bin.style.opacity = '1.00';
						}
						else {
							bin.style.opacity = '0.33';
						}
					}
				}
				current_time = new Date();
				current_time.setTime(current_time.getTime() + ((60*60*1000) * hr));
				current_time.setMinutes(0);
				current_time.setSeconds(0);
				current_time.setMilliseconds(0);
				document.getElementById('timeText').innerText = current_time;
				drawCoverage();
			}
		});
	}
}

if (dataLoaded) {
	infoContainer.style.visibility = 'visible';
	satelliteLegend.style.visibility = 'visible';
	timeText.style.visibility = 'visible';
	timeTicks.style.visibility = 'visible';
	timeSchedule.style.visibility = 'visible';
	document.getElementById('panelMapContainer').style.visibility = 'visible';
	document.getElementById('panelCoverageContainer').style.visibility = 'visible';
	document.getElementById('loadingText').remove();
}
else {
	document.getElementById('loadingText').innerHTML = 'connection to server failed,<br>please try again later';
}

</script>
<style>

* {
	font-family: sans-serif;
}

html {
	display: grid;
	justify-items: center;
	width: 100vw;
	height: 100vh;
	margin: 0;
	overflow: hidden;
	user-select: none;
	background-color: black;
}

body {
	position: relative;
	width: 90vmin;
	height: 90vmin;
	margin: 0;
	border: 5vmin solid black;
	align-self: center;
	background-color: white;
}

#infoContainer {
	position: absolute;
	top: 0;
	width: 4vmin;
	height: 4vmin;
	margin: 2vmin;
	color: black;
	background: white;
	border: 0.25vmin solid black;
	border-radius: 0vmin;
	box-sizing: border-box;
	overflow: hidden;
	cursor: pointer;
	z-index: 5;
	visibility: hidden;
}
#infoContainer.active {
	width: 50vmin;
	height: 50vmin;
}
#infoIcon {
	position: fixed;
	line-height: 3vmin;
	font-size: 3vmin;
	padding: 0.25vmin 0 0 1.25vmin;
}
#infoText {
	line-height: 2.75vmin;
	font-size: 2.5vmin;
	padding: 1.25vmin;
}

#satelliteLegend {
	position: absolute;
	width: 50%;
	margin: 0 25% 0 25%;
	top: 4%;
	visibility: hidden;
}
#satelliteLegend > * > tr {
	height: 2.5vmin;
	text-align: center;
}
#satelliteLegend > * > tr > td > div {
	display: inline-block;
	vertical-align: middle;
	height: 2.5vmin;
	width: 2.5vmin;
}
#satelliteLegend > * > tr > td > a {
	display: inline-block;
	vertical-align: middle;
	height: 2.5vmin;
	line-height: 2.5vmin;
	font-size: 2vmin;
}

#canvasMap, #canvasCoverage {
	position: absolute;
	width: 80%;
	height: auto;
	top: 7%;
	right: 0;
	pointer-events: none;
}
#panelMapContainer, #panelCoverageContainer {
	position: absolute;
	width: 20%;
	height: 65%;
	left: 4%;
	top: 0;
	margin: 14.5% 0 20.5% 0;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
	visibility: hidden;
}
#panelMapContainer > canvas, #panelCoverageContainer > canvas {
	width: 100%;
	height: auto;
	outline: 0.25vmin solid black;
}

#titleText {
	width: 100%;
	text-align: center;
	font-size: 2.5vmin;
	font-weight: bold;
	color: white;
	transform: translateY(-3.5vmin);
}

#timeText {
	width: 100%;
	text-align: center;
	font-size: 2.5vmin;
	color: white;
	transform: translateY(88vmin);
	visibility: hidden;
}

#timeTicks {
	position: absolute;
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	width: 100%;
	bottom: 9%;
	font-size: 2vmin;
	visibility: hidden;
}

#timeSchedule {
	position: absolute;
	width: 100%;
	bottom: 0;
	visibility: hidden;
}
#timeSchedule > * > tr {
	height: 2.5vmin;
}

#loadingText {
	color: black;
	font-size: 5vmin;
	justify-self: center;
	transform: translateY(40vmin);
}

</style>
<script src="https://cdn.jsdelivr.net/npm/topojson@3.0.2/dist/topojson.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/satellite.js@6.0.1/dist/satellite.min.js"></script>